<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  

  <title>
    Set Up GDB &middot; Writing an OS in Rust
  </title>

  <link rel="canonical" href="http://os.phil-opp.com/set-up-gdb.html">

  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/syntax.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/images/favicon.ico">

  

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
  <script src="js/toc.min.js"></script>
  <script src="js/main.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65296949-1', 'auto');
  ga('send', 'pageview');

</script>


  
  <script type="text/javascript">
    if (window.location.hostname == "phil-opp.github.io") {
      window.location.href = "http://os.phil-opp.com/";
    }
  </script>
</head>

<body>
<div class="container content">

<header class="masthead">
  <h3 class="masthead-title">
    <a href="/" title="Home">Writing an OS in Rust</a>
    <span class="navigation">
      <small><a href="/atom.xml"><img src="/images/feed-icon.png" alt="RSS"></a></small>
    </span>
    <small>Philipp&nbsp;Oppermann's&nbsp;blog</small>
  </h3>
</header>

<main>


<article class="post">
  <h1 class="post-title">Set Up GDB</h1>

  

<p>There are a lot of things that can go wrong when developing an OS. So it&rsquo;s a good idea to add a debugger to our toolset, which allows us to set breakpoints and examine variables. We will use <a href="https://www.gnu.org/software/gdb/">GDB</a> as QEMU supports it out of the box.</p>

<h3 id="qemu-parameters">QEMU parameters</h3>

<p>To make QEMU listen for a gdb connection, we add the <code>-s</code> flag to the <code>run</code> target in our Makefile:</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">run</span><span class="o">:</span> <span class="k">$(</span><span class="nv">iso</span><span class="k">)</span>
	@qemu-system-x86_64 -cdrom <span class="k">$(</span>iso<span class="k">)</span> -s
</code></pre></div>

<p>This allows us to connect a debugger at any time, for example to investigate why a panic occurred.</p>

<p>To wait for a debugger connection on startup, we add a <code>debug</code> target to the Makefile:</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">debug</span><span class="o">:</span> <span class="k">$(</span><span class="nv">iso</span><span class="k">)</span>
	@qemu-system-x86_64 -cdrom <span class="k">$(</span>iso<span class="k">)</span> -s -S
</code></pre></div>

<p>It is identical to the <code>run</code> target except for the additional <code>-S</code> flag. This flag causes QEMU to freeze on startup and wait until a debugger is connected. Now it <em>should</em> be possible to connect gdb.</p>

<h3 id="the-annoying-issue">The annoying issue</h3>

<p>Unfortunately gdb has an issue with the switch to long mode. If we connect when the CPU is already in long mode, everything works fine. But if we use <code>make debug</code> and thus connect right at the start, we get an error when we set a breakpoint in 64-bit mode:</p>

<pre><code>Remote 'g' packet reply is too long: [a very long number]
</code></pre>

<p>This issue is known <a href="http://www.cygwin.com/ml/gdb-patches/2012-03/msg00116.html">since 2012</a> but it is still not fixed. Maybe we find the reason in the <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=13984#c11">issue thread</a>:</p>

<blockquote>
<p>from my (limited) experience, unless you ping the gdb-patches list weekly, this patch is more likely to remain forgotten :-)</p>
</blockquote>

<p>Pretty frustrating, especially since the patch is <a href="https://github.com/phil-opp/binutils-gdb/commit/9e88c451844ad38bb82fe77d1f388c87c41b4520">very small</a>.</p>

<h3 id="building-the-patched-gdb">Building the patched GDB</h3>

<p>So the only way to use gdb with <code>make debug</code> is to build a modified gdb version that includes the patch. I created a repository with the patched GDB to make this easy. Just follow <a href="https://github.com/phil-opp/binutils-gdb#gdb-for-64-bit-rust-operating-systems">the build instructions</a>.</p>

<h3 id="connecting-gdb">Connecting GDB</h3>

<p>Now you should have a <code>rust-os-gdb</code> subfolder. In its <code>bin</code> directory you find the <code>gdb</code> executable and the <code>rust-gdb</code> script, which <a href="https://michaelwoerister.github.io/2015/03/27/rust-xxdb.html">improves rendering of Rust types</a>. To make it easy to use it for our OS, we add a <code>make gdb</code> target to our Makefile:</p>
<div class="highlight"><pre><code class="language-make" data-lang="make"><span></span><span class="nf">gdb</span><span class="o">:</span>
	@rust-os-gdb/bin/rust-gdb <span class="s2">&quot;build/kernel-x86_64.bin&quot;</span> -ex <span class="s2">&quot;target remote :1234&quot;</span>
</code></pre></div>

<p>It loads the debug information from our kernel binary and connects to the <code>localhost:1234</code> port, on which QEMU listens by default.</p>

<h3 id="using-gdb">Using GDB</h3>

<p>After connecting to QEMU, you can use various gdb commands to control execution and examine data. All commands can be abbreviated as long they are still unique. For example, you can write <code>c</code> or <code>cont</code> instead of <code>continue</code>. The most important commands are:</p>

<ul>
<li><code>help</code> or <code>h</code>: Show the help.</li>
<li><code>break</code> or <code>b</code>: Set a breakpoint. It possible to break on functions such as <code>rust_main</code> or on source lines such as <code>lib.rs:42</code>. You can use tab for autocompletion and omit parts of the path as long it&rsquo;s still unique. To modify breakpoints, you can use <code>disable</code>, <code>enable</code>, and <code>delete</code> plus the breakpoint number.</li>
<li><code>continue</code> or <code>c</code>: Continue execution until a breakpoint is reached.</li>
<li><code>next</code> or <code>n</code>: Step over the current line and break on the next line of the function. Sometimes this doesn&rsquo;t work in Rust OSes.</li>
<li><code>step</code> or <code>s</code>: Step into the current line, i.e. jump to the called function. Sometimes this doesn&rsquo;t work in Rust OSes.</li>
<li><code>list</code> or <code>l</code>: Shows the source code around the current position.</li>
<li><code>print</code> or <code>p</code>: Prints the value of a variable. You can use Cs <code>*</code> and <code>&amp;</code> operators. To print in hexadecimal, use <code>p/x</code>.</li>
<li><code>tui enable</code>: Enables the text user interface, which provides a graphical interface (see below). To disable it again, run <code>tui disable</code>.</li>
</ul>

<p><img src="images/gdb-tui-screenshot.png" alt="gdb text user interface" /></p>

<p>Of course there are many more commands. Feel free to send a PR if you think this list is missing something important. For a more complete GDB overview, check out <a href="http://beej.us/guide/bggdb/">Beej&rsquo;s Quick Guide</a> or the <a href="http://www.eecs.harvard.edu/~cs161/resources/gdb.html">website for Harvard&rsquo;s CS161 course</a>.</p>

</article>

<div id="disqus_thread"></div>
<script>
  (function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var d = document, s = d.createElement('script');

    s.src = '//phil-opp.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
  anchors.options = {
    placement: 'left',
  };
  anchors.add('article h2, article h3, article h4, article h5, article h6');
</script>

</main>

<footer class="footer">
  <small>
    &copy;
    <time datetime="2017">2017</time>. All rights reserved.
    <a href="/contact.html">Contact</a>
  </small>
</footer>
</div>

</body>
</html>

